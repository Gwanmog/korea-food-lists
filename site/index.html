<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Korea Restaurant Map (Michelin + Blue Ribbon)</title>

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    html, body { height: 100%; margin: 0; }
    #app { display: flex; flex-direction: column; height: 100%; }

    #topbar {
      padding: 10px;
      border-bottom: 1px solid #ddd;
      background: #fff;
      display: grid;
      gap: 8px;
    }

    #map { flex: 1; }

    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .pill { padding: 6px 10px; border: 1px solid #ddd; border-radius: 999px; background: #fafafa; }
    .btn { padding: 8px 10px; border: 1px solid #333; border-radius: 10px; background: #111; color: #fff; cursor: pointer; }
    .btn:disabled { opacity: .4; cursor: not-allowed; }
    .muted { color: #666; font-size: 12px; }
    .popup-title { font-weight: 700; margin-bottom: 6px; }
    .popup-line { margin: 2px 0; }
    .popup-actions { margin-top: 8px; display: flex; gap: 8px; flex-wrap: wrap; }
    .linkbtn { display: inline-block; padding: 7px 10px; border: 1px solid #ddd; border-radius: 10px; text-decoration: none; color: #111; background: #fff; }

    .visually-hidden {
      position: absolute;
      left: -10000px;
      width: 1px;
      height: 1px;
      overflow: hidden;
    }

    /* Sorted list area */
    #listWrap { display: grid; gap: 8px; }
    #listWrap.collapsed #list { display: none; }

    #list {
      min-height: 120px;
      max-height: 320px;
      height: 190px;
      resize: vertical;
      overflow: auto;
      border: 1px solid #eee;
      border-radius: 10px;
      padding: 6px;
      background: #fafafa;
    }

    .list-item {
      padding: 6px 8px;
      border-radius: 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    .list-item:hover { background: #fff; }
    .tag {
      font-size: 12px;
      color: #333;
      border: 1px solid #ddd;
      border-radius: 999px;
      padding: 2px 8px;
      background: #fff;
      white-space: nowrap;
    }
  </style>
</head>

<body>
<div id="app">
  <div id="topbar">
    <div class="row" style="justify-content: space-between;">
      <div class="row">
        <button id="locBtn" class="btn">Use my location</button>
        <span id="locStatus" class="muted">Location not set</span>
      </div>
      <span class="muted">Tip: ‚ÄúUse my location‚Äù enables Kakao/Google directions</span>
    </div>

    <div class="row">
      <span class="pill"><label><input type="checkbox" id="f_michelin" checked> Michelin</label></span>
      <span class="pill"><label><input type="checkbox" id="f_blu" checked> Blue Ribbon</label></span>

      <span class="pill"><label><input type="checkbox" id="f_m1" checked> ‚≠ê</label></span>
      <span class="pill"><label><input type="checkbox" id="f_m2" checked> ‚≠ê‚≠ê</label></span>
      <span class="pill"><label><input type="checkbox" id="f_m3" checked> ‚≠ê‚≠ê‚≠ê</label></span>
      <span class="pill"><label><input type="checkbox" id="f_bib" checked> üü¢ Bib</label></span>
      <span class="pill"><label><input type="checkbox" id="f_sel" checked> Selected</label></span>

      <span class="pill"><label><input type="checkbox" id="f_r1" checked> üîµ</label></span>
      <span class="pill"><label><input type="checkbox" id="f_r2" checked> üîµüîµ</label></span>
      <span class="pill"><label><input type="checkbox" id="f_r3" checked> üîµüîµüîµ</label></span>
    </div>

    <div class="row">
      <label for="q" class="visually-hidden">Search restaurants</label>
      <input id="q" type="search"
             placeholder="Search name / cuisine / address‚Ä¶"
             style="flex:1; padding:10px; border-radius:10px; border:1px solid #ddd;">
      <span id="count" class="muted"></span>
      <button id="fitBtn" class="btn" style="background:#fff;color:#111;border-color:#ddd;">Fit</button>
    </div>

    <div id="listWrap">
      <div class="row" style="justify-content: space-between;">
        <span class="muted">Sorted (best first)</span>
        <button id="toggleList" class="btn" style="background:#fff;color:#111;border-color:#ddd;">Hide list</button>
      </div>
      <div id="list" aria-label="Sorted restaurant list"></div>
    </div>
  </div>

  <div id="map"></div>
</div>

<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>

<script>
  function enc(s) { return encodeURIComponent(s || ""); }

  // Kakao mobile web scheme (browser-friendly)
  function kakaoLookWeb(lat, lon) { return `http://m.map.kakao.com/scheme/look?p=${lat},${lon}`; }
  function kakaoSearchWeb(query, centerLatLon) {
    if (centerLatLon) return `http://m.map.kakao.com/scheme/search?q=${enc(query)}&p=${centerLatLon}`;
    return `http://m.map.kakao.com/scheme/search?q=${enc(query)}`;
  }
  function kakaoRouteWeb(spLat, spLon, epLat, epLon, by) {
    return `http://m.map.kakao.com/scheme/route?sp=${spLat},${spLon}&ep=${epLat},${epLon}&by=${enc(by || "foot")}`;
  }

  // Google Maps
  function googleSearch(query) { return `https://www.google.com/maps/search/?api=1&query=${enc(query)}`; }
  function googleLook(lat, lon) { return `https://www.google.com/maps/search/?api=1&query=${lat},${lon}`; }
  function googleDirections(spLat, spLon, epLat, epLon, mode) {
    return `https://www.google.com/maps/dir/?api=1&origin=${spLat},${spLon}&destination=${epLat},${epLon}&travelmode=${enc(mode || "walking")}`;
  }

  // Map
  const map = L.map('map', { zoomControl: true }).setView([37.5665, 126.9780], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  let userLoc = null;
  let userMarker = null;

  const locBtn = document.getElementById("locBtn");
  const locStatus = document.getElementById("locStatus");
  const qEl = document.getElementById("q");
  const countEl = document.getElementById("count");
  const listEl = document.getElementById("list");
  const fitBtn = document.getElementById("fitBtn");

  const listWrap = document.getElementById("listWrap");
  const toggleListBtn = document.getElementById("toggleList");
  toggleListBtn.addEventListener("click", () => {
    listWrap.classList.toggle("collapsed");
    toggleListBtn.textContent = listWrap.classList.contains("collapsed") ? "Show list" : "Hide list";
  });

  const filters = {
    michelin: document.getElementById("f_michelin"),
    blu: document.getElementById("f_blu"),
    m1: document.getElementById("f_m1"),
    m2: document.getElementById("f_m2"),
    m3: document.getElementById("f_m3"),
    bib: document.getElementById("f_bib"),
    m_sel: document.getElementById("f_sel"),
    r1: document.getElementById("f_r1"),
    r2: document.getElementById("f_r2"),
    r3: document.getElementById("f_r3"),
  };

  function michelinTierOk(cat) {
    cat = (cat || "").toLowerCase().trim();
    if (!cat) return false;

    if ((cat.includes("3") && cat.includes("star")) || (cat.includes("three") && cat.includes("star"))) return filters.m3.checked;
    if ((cat.includes("2") && cat.includes("star")) || (cat.includes("two") && cat.includes("star"))) return filters.m2.checked;
    if ((cat.includes("1") && cat.includes("star")) || (cat.includes("one") && cat.includes("star"))) return filters.m1.checked;

    if (cat.includes("bib")) return filters.bib.checked;
    if (cat.includes("selected")) return filters.m_sel.checked;

    return false;
  }

  function ribbonTierOk(cat) {
    cat = (cat || "").toUpperCase();
    if (cat === "RIBBON_THREE") return filters.r3.checked;
    if (cat === "RIBBON_TWO") return filters.r2.checked;
    if (cat === "RIBBON_ONE") return filters.r1.checked;
    return false;
  }

  function passesFilters(p) {
    const src = (p.source || "").toLowerCase();

    if (src.includes("michelin")) {
      if (!filters.michelin.checked) return false;
      return michelinTierOk(p.category);
    }
    if (src.includes("blue")) {
      if (!filters.blu.checked) return false;
      return ribbonTierOk(p.category);
    }
    return false;
  }

  function textMatch(p, q) {
    if (!q) return true;
    q = q.toLowerCase();
    const hay = [p.name, p.category, p.cuisine, p.address, p.source].filter(Boolean).join(" ").toLowerCase();
    return hay.includes(q);
  }

  function escapeHtml(s) {
    return (s || "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }
  function escapeAttr(s) { return escapeHtml(s); }

  function shortGoogleQuery(p) {
  const name = (p.name || "").trim();
  // Google tends to resolve the place better with "Name + Seoul"
  // than with a big English address blob.
  return name ? `${name} Seoul` : "Seoul";
}

  function shortKakaoQuery(p) {
    // Kakao search is VERY sensitive to long English address blobs.
    // Use name only.
    return (p.name || "").trim();
  }

  function popupHtml(p, lat, lon) {
    const title = `<div class="popup-title">${escapeHtml(p.name || "")}</div>`;
    const lines = [];
    if (p.source) lines.push(`<div class="popup-line"><b>Source</b>: ${escapeHtml(p.source)}</div>`);
    if (p.category) lines.push(`<div class="popup-line"><b>Category</b>: ${escapeHtml(p.category)}</div>`);
    if (p.cuisine) lines.push(`<div class="popup-line"><b>Cuisine</b>: ${escapeHtml(p.cuisine)}</div>`);
    if (p.address) lines.push(`<div class="popup-line"><b>Address</b>: ${escapeHtml(p.address)}</div>`);

    const actions = [];
    const target = ' target="_blank" rel="noopener" ';

    // Best Kakao option: direct place_url from enrichment
    if (p.kakao_url) {
      actions.push(`<a class="linkbtn" href="${escapeAttr(p.kakao_url)}"${target}>Open in KakaoMap (place)</a>`);
    } else if (lat != null && lon != null) {
      // fallback: search by NAME ONLY, centered on coords
      actions.push(`<a class="linkbtn" href="${kakaoSearchWeb(shortKakaoQuery(p), `${lat},${lon}`)}"${target}>Search in KakaoMap</a>`);
      actions.push(`<a class="linkbtn" href="${kakaoLookWeb(lat, lon)}"${target}>Kakao pin</a>`);
    }

    // Google: offer BOTH search + pin (pin is reliable, search is nicer when it works)
    if (lat != null && lon != null) {
      actions.push(`<a class="linkbtn" href="${googleSearch(shortGoogleQuery(p))}"${target}>Search in Google Maps</a>`);
      actions.push(`<a class="linkbtn" href="${googleLook(lat, lon)}"${target}>Google pin</a>`);
    } else {
      actions.push(`<a class="linkbtn" href="${googleSearch(shortGoogleQuery(p))}"${target}>Search in Google Maps</a>`);
    }

    // Directions (only if user location is set + coords exist)
    if (userLoc && lat != null && lon != null) {
      actions.push(`<a class="linkbtn" href="${kakaoRouteWeb(userLoc.lat, userLoc.lon, lat, lon, 'foot')}"${target}>Kakao directions (walk)</a>`);
      actions.push(`<a class="linkbtn" href="${kakaoRouteWeb(userLoc.lat, userLoc.lon, lat, lon, 'publictransit')}"${target}>Kakao directions (transit)</a>`);
      actions.push(`<a class="linkbtn" href="${googleDirections(userLoc.lat, userLoc.lon, lat, lon, 'walking')}"${target}>Google directions (walk)</a>`);
      actions.push(`<a class="linkbtn" href="${googleDirections(userLoc.lat, userLoc.lon, lat, lon, 'transit')}"${target}>Google directions (transit)</a>`);
    } else if (lat != null && lon != null) {
      actions.push(`<span class="muted">Tap ‚ÄúUse my location‚Äù to enable directions.</span>`);
    }

    if (p.url) actions.push(`<a class="linkbtn" href="${escapeAttr(p.url)}"${target}>Source page</a>`);

    return title + lines.join("") + `<div class="popup-actions">${actions.join("")}</div>`;
  }

  function michelinRank(cat) {
    cat = (cat || "").toLowerCase();
    if (cat.includes("3") && cat.includes("star")) return 300;
    if (cat.includes("three") && cat.includes("star")) return 300;
    if (cat.includes("2") && cat.includes("star")) return 200;
    if (cat.includes("two") && cat.includes("star")) return 200;
    if (cat.includes("1") && cat.includes("star")) return 100;
    if (cat.includes("one") && cat.includes("star")) return 100;
    if (cat.includes("bib")) return 50;
    if (cat.includes("selected")) return 10;
    return 0;
  }
  function blueRank(cat) {
    cat = (cat || "").toUpperCase();
    if (cat === "RIBBON_THREE") return 30;
    if (cat === "RIBBON_TWO") return 20;
    if (cat === "RIBBON_ONE") return 10;
    return 0;
  }
  function placeRank(p) {
    const src = (p.source || "").toLowerCase();
    if (src.includes("michelin")) return 1000 + michelinRank(p.category);
    if (src.includes("blue")) return 500 + blueRank(p.category);
    return 0;
  }
  function badgeText(p) {
    const src = (p.source || "").toLowerCase();
    const cat = (p.category || "");
    if (src.includes("michelin")) return cat || "Michelin";
    if (src.includes("blue")) {
      if (cat === "RIBBON_THREE") return "Blue 3";
      if (cat === "RIBBON_TWO") return "Blue 2";
      if (cat === "RIBBON_ONE") return "Blue 1";
      return "Blue";
    }
    return "";
  }

  function setUserLocation(lat, lon) {
    userLoc = { lat, lon };
    locStatus.textContent = `Location set: ${lat.toFixed(5)}, ${lon.toFixed(5)}`;
    if (userMarker) userMarker.remove();
    userMarker = L.marker([lat, lon]).addTo(map).bindPopup("You are here");
  }

  locBtn.addEventListener("click", () => {
    if (!navigator.geolocation) { alert("Geolocation not supported."); return; }
    locBtn.disabled = true;
    locStatus.textContent = "Getting location‚Ä¶";
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        setUserLocation(pos.coords.latitude, pos.coords.longitude);
        map.setView([pos.coords.latitude, pos.coords.longitude], 14);
        locBtn.disabled = false;
        render();
      },
      (err) => { locStatus.textContent = `Location failed: ${err.message}`; locBtn.disabled = false; },
      { enableHighAccuracy: true, timeout: 15000, maximumAge: 30000 }
    );
  });

  Object.values(filters).forEach(cb => cb.addEventListener("change", render));
  qEl.addEventListener("input", render);
  fitBtn.addEventListener("click", () => {
    if (!layer) return;
    const bounds = layer.getBounds && layer.getBounds();
    if (bounds && bounds.isValid && bounds.isValid()) map.fitBounds(bounds.pad(0.15));
  });

  let allFeatures = [];
  let layer = null;

  function render() {
    const q = (qEl.value || "").trim();
    const filtered = allFeatures.filter(f => {
      const p = f.properties || {};
      return passesFilters(p) && textMatch(p, q);
    });

    const sorted = filtered.slice().sort((a, b) => {
      const pa = a.properties || {};
      const pb = b.properties || {};
      const ra = placeRank(pa);
      const rb = placeRank(pb);
      if (ra !== rb) return rb - ra;
      return String(pa.name || "").localeCompare(String(pb.name || ""), undefined, { sensitivity: "base" });
    });

    if (layer) { layer.remove(); layer = null; }

    layer = L.geoJSON(sorted, {
      pointToLayer: (feature, latlng) => L.circleMarker(latlng, { radius: 7, weight: 2, fillOpacity: 0.6 }),
      onEachFeature: (feature, l) => {
        const p = feature.properties || {};
        const coords = feature.geometry && feature.geometry.coordinates;
        const lon = coords ? coords[0] : null;
        const lat = coords ? coords[1] : null;
        l.bindPopup(popupHtml(p, lat, lon), { maxWidth: 360 });
      }
    }).addTo(map);

    listEl.innerHTML = "";
    const itemLayers = [];
    layer.eachLayer(l => itemLayers.push(l));

    itemLayers.forEach(l => {
      const f = l.feature || {};
      const p = (f.properties || {});
      const div = document.createElement("div");
      div.className = "list-item";

      const nameEl = document.createElement("div");
      nameEl.textContent = p.name || "(unnamed)";

      const tagEl = document.createElement("div");
      tagEl.className = "tag";
      tagEl.textContent = badgeText(p);

      div.appendChild(nameEl);
      if (tagEl.textContent) div.appendChild(tagEl);

      div.addEventListener("click", () => {
        const latlng = l.getLatLng && l.getLatLng();
        if (latlng) map.setView(latlng, Math.max(map.getZoom(), 15));
        if (l.openPopup) l.openPopup();
      });

      listEl.appendChild(div);
    });

    countEl.textContent = `${sorted.length} places shown`;
  }

  async function boot() {
    const url = "./places.geojson";
    const r = await fetch(url);
    if (!r.ok) throw new Error(`Failed to load ${url}: ${r.status}`);
    const geo = await r.json();
    allFeatures = geo.features || [];
    render();
  }

  boot().catch(e => { alert(e.message); console.error(e); });
</script>
</body>
</html>

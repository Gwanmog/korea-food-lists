<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Eat my Seoul</title>

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    :root {
      --bg: #ffffff;
      --panel: #ffffff;
      --panel2: #fafafa;
      --text: #111111;
      --muted: #666666;
      --border: #dddddd;

      --btn-bg: #111111;
      --btn-text: #ffffff;
      --btn-border: #111111;

      --btn2-bg: #ffffff;
      --btn2-text: #111111;
      --btn2-border: #dddddd;

      --hover: #ffffff;
      --tag-bg: #ffffff;
      --tag-text: #333333;
      --tag-border: #dddddd;

      --shadow: 0 8px 24px rgba(0,0,0,0.06);
    }

    /* Dark mode */
    body.dark {
      --bg: #0b0d12;
      --panel: #101522;
      --panel2: #0e1320;
      --text: #e8ecf6;
      --muted: #aab2c5;
      --border: rgba(255,255,255,0.10);

      --btn-bg: #e8ecf6;
      --btn-text: #0b0d12;
      --btn-border: rgba(255,255,255,0.25);

      --btn2-bg: rgba(255,255,255,0.06);
      --btn2-text: #e8ecf6;
      --btn2-border: rgba(255,255,255,0.14);

      --hover: rgba(255,255,255,0.06);
      --tag-bg: rgba(255,255,255,0.06);
      --tag-text: #e8ecf6;
      --tag-border: rgba(255,255,255,0.14);

      --shadow: 0 10px 30px rgba(0,0,0,0.35);
    }

    html, body { height: 100%; margin: 0; }
    body { background: var(--bg); color: var(--text); }
    #app { display: flex; flex-direction: column; height: 100%; }

    #topbar {
      padding: 10px;
      border-bottom: 1px solid var(--border);
      background: var(--panel);
      display: grid;
      gap: 8px;
      box-shadow: var(--shadow);
      z-index: 999;
    }

    #map { flex: 1; }

    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .pill {
      padding: 6px 10px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: var(--panel2);
      color: var(--text);
    }

    .btn {
      padding: 8px 10px;
      border: 1px solid var(--btn-border);
      border-radius: 10px;
      background: var(--btn-bg);
      color: var(--btn-text);
      cursor: pointer;
      transition: transform .05s ease, opacity .2s ease;
    }
    .btn:hover { transform: translateY(-1px); }
    .btn:disabled { opacity: .4; cursor: not-allowed; transform: none; }

    .btn.secondary {
      background: var(--btn2-bg);
      color: var(--btn2-text);
      border-color: var(--btn2-border);
    }

    .muted { color: var(--muted); font-size: 12px; }

    .title {
      font-weight: 800;
      letter-spacing: 0.2px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--panel2);
      user-select: none;
      white-space: nowrap;
    }
    .title .spark { opacity: .9; }

    /* Search input */
    #q {
      background: var(--panel2);
      color: var(--text);
      border: 1px solid var(--border) !important;
      outline: none;
    }
    #q::placeholder { color: var(--muted); }

    /* Popup + links */
    .popup-title { font-weight: 800; margin-bottom: 6px; }
    .popup-line { margin: 2px 0; }
    .popup-actions { margin-top: 8px; display: flex; gap: 8px; flex-wrap: wrap; }
    .linkbtn {
      display: inline-block;
      padding: 7px 10px;
      border: 1px solid var(--border);
      border-radius: 10px;
      text-decoration: none;
      color: var(--text);
      background: var(--panel2);
    }
    .linkbtn:hover { background: var(--hover); }

    .visually-hidden {
      position: absolute;
      left: -10000px;
      width: 1px;
      height: 1px;
      overflow: hidden;
    }

    /* Sorted list area */
    #listWrap { display: grid; gap: 8px; }
    #listWrap.collapsed #list { display: none; }

    #list {
      min-height: 120px;
      max-height: 320px;
      height: 190px;
      resize: vertical;
      overflow: auto;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 6px;
      background: var(--panel2);
    }

    .list-item {
      padding: 6px 8px;
      border-radius: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    .list-item:hover { background: var(--hover); }

    .tag {
      font-size: 12px;
      color: var(--tag-text);
      border: 1px solid var(--tag-border);
      border-radius: 999px;
      padding: 2px 8px;
      background: var(--tag-bg);
      white-space: nowrap;
    }

    /* Make leaflet controls look nicer in dark mode */
    body.dark .leaflet-control-zoom a {
      background: var(--panel) !important;
      color: var(--text) !important;
      border-color: var(--border) !important;
    }
    body.dark .leaflet-control-attribution {
      background: rgba(16, 21, 34, 0.75) !important;
      color: var(--muted) !important;
      border: 1px solid var(--border) !important;
    }
    body.dark .leaflet-control-attribution a { color: var(--text) !important; }

    /* ---------- Mobile layout: compact header + collapsible panel ---------- */
    .panel { display: contents; } /* desktop: panel doesn't change layout */
    .tip { display: inline; }

    @media (max-width: 640px) {
      :root { --hdr-h: 64px; }

      #topbar {
        position: fixed;
        top: 0; left: 0; right: 0;
        padding: 8px 10px;
      }

      #map {
        height: calc(100vh - var(--hdr-h));
        margin-top: var(--hdr-h);
      }

      .title { font-size: 16px; padding: 6px 10px; }
      .pill { padding: 4px 8px; }
      .btn { padding: 7px 10px; border-radius: 10px; }
      .muted { font-size: 12px; }

      .tip { display: none; }
      #locStatus { display: none; }

      .panel {
        display: none;
        position: fixed;
        top: var(--hdr-h);
        left: 0; right: 0;
        max-height: calc(100vh - var(--hdr-h));
        overflow-y: auto;
        padding: 10px;
        background: var(--panel);
        border-top: 1px solid var(--border);
        box-shadow: var(--shadow);
        z-index: 998;
      }
      .panel.open { display: block; }

      .row { gap: 6px; }
      #q { min-width: 0; }
    }
  </style>
</head>

<body class="dark">
<div id="app">
  <div id="topbar">
    <!-- Top row: stays compact on mobile -->
    <div class="row" style="justify-content: space-between;">
      <div class="row">
        <div class="title" title="Eat my Seoul">
          <span class="spark">üçú</span>
          <span>Eat my Seoul</span>
        </div>

        <button id="locBtn" class="btn">Use my location</button>
        <span id="locStatus" class="muted">Location not set</span>
      </div>

      <div class="row">
  <button id="themeBtn" class="btn secondary" title="Toggle dark mode">üåô Dark</button>

  <div class="row" style="gap:6px;">
    <button id="langEn" class="btn secondary" title="English">üá∫üá∏</button>
    <button id="langKo" class="btn secondary" title="ÌïúÍµ≠Ïñ¥">üá∞üá∑</button>
  </div>

  <button id="panelBtn" class="btn secondary" title="Show/hide filters">‚ò∞ Filters</button>
  <span id="tipText" class="muted tip">Tip: ‚ÄúUse my location‚Äù enables Kakao/Google directions</span>
</div>

    </div>

    <!-- Collapsible panel (closed on mobile, open on desktop) -->
    <div id="panel" class="panel open">

      <div class="row">
        <span class="pill"><label><input type="checkbox" id="f_michelin" checked> <span id="lblMichelin">Michelin</span></label></span>
<span class="pill"><label><input type="checkbox" id="f_blu" checked> <span id="lblBlueRibbon">Blue Ribbon</span></label></span>

        <span class="pill"><label><input type="checkbox" id="f_m1" checked> ‚≠ê</label></span>
        <span class="pill"><label><input type="checkbox" id="f_m2" checked> ‚≠ê‚≠ê</label></span>
        <span class="pill"><label><input type="checkbox" id="f_m3" checked> ‚≠ê‚≠ê‚≠ê</label></span>
        <span class="pill"><label><input type="checkbox" id="f_bib" checked> üü¢ Bib</label></span>
        <span class="pill"><label><input type="checkbox" id="f_sel" checked> Selected</label></span>

        <span class="pill"><label><input type="checkbox" id="f_r1" checked> üîµ</label></span>
        <span class="pill"><label><input type="checkbox" id="f_r2" checked> üîµüîµ</label></span>
        <span class="pill"><label><input type="checkbox" id="f_r3" checked> üîµüîµüîµ</label></span>
      </div>

      <div class="row">
        <label for="q" class="visually-hidden">Search restaurants</label>
        <input id="q" type="search"
               placeholder="Search name / cuisine / address‚Ä¶"
               style="flex:1; padding:10px; border-radius:10px;">
        <span id="count" class="muted"></span>
        <button id="fitBtn" class="btn secondary">Fit</button>
      </div>

      <!-- List hidden by default -->
      <div id="listWrap" class="collapsed">
        <div class="row" style="justify-content: space-between;">
          <span id="sortedText" class="muted">Sorted (best first)</span>
<button id="toggleList" class="btn secondary">Show list</button>
        </div>
        <div id="list" aria-label="Sorted restaurant list"></div>
      </div>

    </div>
  </div>

  <div id="map"></div>
</div>

<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>

<script>
  function enc(s) { return encodeURIComponent(s || ""); }

  // Kakao mobile web scheme (browser-friendly)
  function kakaoLookWeb(lat, lon) { return `http://m.map.kakao.com/scheme/look?p=${lat},${lon}`; }
  function kakaoSearchWeb(query, centerLatLon) {
    if (centerLatLon) return `http://m.map.kakao.com/scheme/search?q=${enc(query)}&p=${centerLatLon}`;
    return `http://m.map.kakao.com/scheme/search?q=${enc(query)}`;
  }
  function kakaoRouteWeb(spLat, spLon, epLat, epLon, by) {
    return `http://m.map.kakao.com/scheme/route?sp=${spLat},${spLon}&ep=${epLat},${epLon}&by=${enc(by || "foot")}`;
  }

  // Google Maps
  function googleSearch(query) { return `https://www.google.com/maps/search/?api=1&query=${enc(query)}`; }
  function googleLook(lat, lon) { return `https://www.google.com/maps/search/?api=1&query=${lat},${lon}`; }
  function googleDirections(spLat, spLon, epLat, epLon, mode) {
    return `https://www.google.com/maps/dir/?api=1&origin=${spLat},${spLon}&destination=${epLat},${epLon}&travelmode=${enc(mode || "walking")}`;
  }

  // Map
  const map = L.map('map', { zoomControl: true }).setView([37.5665, 126.9780], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  let userLoc = null;
  let userMarker = null;

  const locBtn = document.getElementById("locBtn");
  const locStatus = document.getElementById("locStatus");
  const qEl = document.getElementById("q");
  const countEl = document.getElementById("count");
  const listEl = document.getElementById("list");
  const fitBtn = document.getElementById("fitBtn");

  const listWrap = document.getElementById("listWrap");
  const toggleListBtn = document.getElementById("toggleList");

  // Theme toggle (default dark, persisted)
  const themeBtn = document.getElementById("themeBtn");
  function applyTheme(isDark) {
    document.body.classList.toggle("dark", !!isDark);
    themeBtn.textContent = isDark ? "üåô Dark" : "‚òÄÔ∏è Light";
    try { localStorage.setItem("theme", isDark ? "dark" : "light"); } catch (_) {}
  }
  (function initTheme() {
    let saved = null;
    try { saved = localStorage.getItem("theme"); } catch (_) {}
    // default: dark
    const isDark = (saved === "light") ? false : true;
    applyTheme(isDark);
  })();
  themeBtn.addEventListener("click", () => {
    const isDarkNow = document.body.classList.contains("dark");
    applyTheme(!isDarkNow);
  });

  // List toggle (hidden by default via class="collapsed" in HTML)
  toggleListBtn.addEventListener("click", () => {
    listWrap.classList.toggle("collapsed");
    toggleListBtn.textContent = listWrap.classList.contains("collapsed")
  ? I18N[LANG].showList
  : I18N[LANG].hideList;
  });

  // Mobile panel toggle
  const panelBtn = document.getElementById("panelBtn");
  const panel = document.getElementById("panel");
  // ---------------- i18n (EN/KR) ----------------
const langEnBtn = document.getElementById("langEn");
const langKoBtn = document.getElementById("langKo");

const tipTextEl = document.getElementById("tipText");
const lblMichelinEl = document.getElementById("lblMichelin");
const lblBlueRibbonEl = document.getElementById("lblBlueRibbon");
const sortedTextEl = document.getElementById("sortedText");

const I18N = {
  en: {
    pageTitle: "Eat my Seoul",
    title: "Eat my Seoul",
    useMyLocation: "Use my location",
    locationNotSet: "Location not set",
    gettingLocation: "Getting location‚Ä¶",
    locationSet: (lat, lon) => `Location set: ${lat.toFixed(5)}, ${lon.toFixed(5)}`,
    locationFailed: (msg) => `Location failed: ${msg}`,
    tip: 'Tip: ‚ÄúUse my location‚Äù enables Kakao/Google directions',
    filtersOpen: "‚úï Close",
    filtersClosed: "‚ò∞ Filters",
    michelin: "Michelin",
    blueRibbon: "Blue Ribbon",
    searchPlaceholder: "Search name / cuisine / address‚Ä¶",
    fit: "Fit",
    sorted: "Sorted (best first)",
    showList: "Show list",
    hideList: "Hide list",
    source: "Source",
    category: "Category",
    cuisine: "Cuisine",
    address: "Address",
    openKakaoPlace: ${t.openKakaoPlace},
    searchKakao: ${t.searchKakao},
    kakaoPin: ${t.kakaoPin},
    searchGoogle: ${t.searchGoogle},
    googlePin: ${t.googlePin},
    kakaoWalk: ${t.kakaoWalk},
    kakaoTransit: "Kakao directions (transit)",
    googleWalk: "Google directions (walk)",
    googleTransit: "Google directions (transit)",
    enableDirections: ${t.enableDirections},
    sourcePage: ${t.sourcePage},
    placesShown: (n) => `${n} places shown`,
  },
  ko: {
    pageTitle: "Î®πÍ≥† Îòê Î®πÍ≥†, ÏÑúÏö∏ (Eat my Seoul)",
    title: "Eat my Seoul",
    useMyLocation: "ÎÇ¥ ÏúÑÏπò ÏÇ¨Ïö©",
    locationNotSet: "ÏúÑÏπò ÎØ∏ÏÑ§Ï†ï",
    gettingLocation: "ÏúÑÏπò ÌôïÏù∏ Ï§ë‚Ä¶",
    locationSet: (lat, lon) => `ÏúÑÏπò ÏÑ§Ï†ïÎê®: ${lat.toFixed(5)}, ${lon.toFixed(5)}`,
    locationFailed: (msg) => `ÏúÑÏπò ÌôïÏù∏ Ïã§Ìå®: ${msg}`,
    tip: "ÌåÅ: ‚ÄúÎÇ¥ ÏúÑÏπò ÏÇ¨Ïö©‚ÄùÏùÑ ÎàÑÎ•¥Î©¥ Ïπ¥Ïπ¥Ïò§/Íµ¨Í∏Ä Í∏∏Ï∞æÍ∏∞Í∞Ä ÌôúÏÑ±ÌôîÎèºÏöî",
    filtersOpen: "‚úï Îã´Í∏∞",
    filtersClosed: "‚ò∞ ÌïÑÌÑ∞",
    michelin: "ÎØ∏ÏâêÎ¶∞",
    blueRibbon: "Î∏îÎ£®Î¶¨Î≥∏",
    searchPlaceholder: "Ïù¥Î¶Ñ / ÏùåÏãù Ï¢ÖÎ•ò / Ï£ºÏÜå Í≤ÄÏÉâ‚Ä¶",
    fit: "ÎßûÏ∂§",
    sorted: "Ï†ïÎ†¨ (Ï∂îÏ≤ú Ïàú)",
    showList: "Î™©Î°ù Î≥¥Í∏∞",
    hideList: "Î™©Î°ù Ïà®Í∏∞Í∏∞",
    source: "Ï∂úÏ≤ò",
    category: "Îì±Í∏â",
    cuisine: "ÏùåÏãù",
    address: "Ï£ºÏÜå",
    openKakaoPlace: "Ïπ¥Ïπ¥Ïò§Îßµ Ïó¥Í∏∞ (Ïû•ÏÜå)",
    searchKakao: "Ïπ¥Ïπ¥Ïò§ÎßµÏóêÏÑú Í≤ÄÏÉâ",
    kakaoPin: "Ïπ¥Ïπ¥Ïò§ ÌïÄ",
    searchGoogle: "Íµ¨Í∏Ä ÏßÄÎèÑÏóêÏÑú Í≤ÄÏÉâ",
    googlePin: "Íµ¨Í∏Ä ÌïÄ",
    kakaoWalk: "Ïπ¥Ïπ¥Ïò§ Í∏∏Ï∞æÍ∏∞ (ÎèÑÎ≥¥)",
    kakaoTransit: "Ïπ¥Ïπ¥Ïò§ Í∏∏Ï∞æÍ∏∞ (ÎåÄÏ§ëÍµêÌÜµ)",
    googleWalk: "Íµ¨Í∏Ä Í∏∏Ï∞æÍ∏∞ (ÎèÑÎ≥¥)",
    googleTransit: "Íµ¨Í∏Ä Í∏∏Ï∞æÍ∏∞ (ÎåÄÏ§ëÍµêÌÜµ)",
    enableDirections: "‚ÄúÎÇ¥ ÏúÑÏπò ÏÇ¨Ïö©‚ÄùÏùÑ ÎàÑÎ•¥Î©¥ Í∏∏Ï∞æÍ∏∞Î•º ÏÇ¨Ïö©Ìï† Ïàò ÏûàÏñ¥Ïöî.",
    sourcePage: "Ï∂úÏ≤ò ÌéòÏù¥ÏßÄ",
    placesShown: (n) => `${n}Í≥≥ ÌëúÏãú`,
  }
};

let LANG = "en";

function setLang(next) {
  LANG = (next === "ko") ? "ko" : "en";
  try { localStorage.setItem("lang", LANG); } catch (_) {}
  applyLang();
}

function getLang() {
  let saved = null;
  try { saved = localStorage.getItem("lang"); } catch (_) {}
  if (saved === "en" || saved === "ko") return saved;
  // auto-detect: Korean phones/browsers
  const nav = (navigator.language || "").toLowerCase();
  return nav.startsWith("ko") ? "ko" : "en";
}

function applyLang() {
  const t = I18N[LANG];

  // Page title (tab)
  document.title = t.pageTitle;

  // Header buttons/text
  locBtn.textContent = t.useMyLocation;
  if (!userLoc) locStatus.textContent = t.locationNotSet;

  // Tip + labels
  if (tipTextEl) tipTextEl.textContent = t.tip;
  if (lblMichelinEl) lblMichelinEl.textContent = t.michelin;
  if (lblBlueRibbonEl) lblBlueRibbonEl.textContent = t.blueRibbon;
  if (sortedTextEl) sortedTextEl.textContent = t.sorted;

  // Search + fit
  qEl.placeholder = t.searchPlaceholder;
  fitBtn.textContent = t.fit;

  // Panel button text (depends on open/closed)
  if (panelBtn && panel) {
    panelBtn.textContent = panel.classList.contains("open") ? t.filtersOpen : t.filtersClosed;
  }

  // List toggle button (depends on collapsed)
  toggleListBtn.textContent = listWrap.classList.contains("collapsed") ? t.showList : t.hideList;

  // Re-render so popup/list text uses the new language
  render();
}

langEnBtn.addEventListener("click", () => setLang("en"));
langKoBtn.addEventListener("click", () => setLang("ko"));

// init language
setLang(getLang());


  function isMobile() {
    return window.matchMedia("(max-width: 640px)").matches;
  }

  function setPanelOpen(open) {
    panel.classList.toggle("open", !!open);
    panelBtn.textContent = panel.classList.contains("open")
  ? I18N[LANG].filtersOpen
  : I18N[LANG].filtersClosed;
  }

  // default: open on desktop, closed on mobile
  (function initPanel() {
    setPanelOpen(!isMobile());
  })();

  panelBtn.addEventListener("click", () => {
    setPanelOpen(!panel.classList.contains("open"));
  });

  window.addEventListener("resize", () => {
    setPanelOpen(!isMobile());
  });

  const filters = {
    michelin: document.getElementById("f_michelin"),
    blu: document.getElementById("f_blu"),
    m1: document.getElementById("f_m1"),
    m2: document.getElementById("f_m2"),
    m3: document.getElementById("f_m3"),
    bib: document.getElementById("f_bib"),
    m_sel: document.getElementById("f_sel"),
    r1: document.getElementById("f_r1"),
    r2: document.getElementById("f_r2"),
    r3: document.getElementById("f_r3"),
  };

  function michelinTierOk(cat) {
    cat = (cat || "").toLowerCase().trim();
    if (!cat) return false;

    if ((cat.includes("3") && cat.includes("star")) || (cat.includes("three") && cat.includes("star"))) return filters.m3.checked;
    if ((cat.includes("2") && cat.includes("star")) || (cat.includes("two") && cat.includes("star"))) return filters.m2.checked;
    if ((cat.includes("1") && cat.includes("star")) || (cat.includes("one") && cat.includes("star"))) return filters.m1.checked;

    if (cat.includes("bib")) return filters.bib.checked;
    if (cat.includes("selected")) return filters.m_sel.checked;

    return false;
  }

  function ribbonTierOk(cat) {
    cat = (cat || "").toUpperCase();
    if (cat === "RIBBON_THREE") return filters.r3.checked;
    if (cat === "RIBBON_TWO") return filters.r2.checked;
    if (cat === "RIBBON_ONE") return filters.r1.checked;
    return false;
  }

  function passesFilters(p) {
    const src = (p.source || "").toLowerCase();

    if (src.includes("michelin")) {
      if (!filters.michelin.checked) return false;
      return michelinTierOk(p.category);
    }
    if (src.includes("blue")) {
      if (!filters.blu.checked) return false;
      return ribbonTierOk(p.category);
    }
    return false;
  }

  function textMatch(p, q) {
    if (!q) return true;
    q = q.toLowerCase();
    const hay = [p.name, p.category, p.cuisine, p.address, p.source].filter(Boolean).join(" ").toLowerCase();
    return hay.includes(q);
  }

  function escapeHtml(s) {
    return (s || "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }
  function escapeAttr(s) { return escapeHtml(s); }

  function shortGoogleQuery(p) {
    const name = (p.name || "").trim();
    return name ? `${name} Seoul` : "Seoul";
  }

  function shortKakaoQuery(p) {
    return (p.name || "").trim();
  }

  function popupHtml(p, lat, lon) {
    const t = I18N[LANG];
    const title = `<div class="popup-title">${escapeHtml(p.name || "")}</div>`;
    const lines = [];
    if (p.source) lines.push(`<div class="popup-line"><b>${t.source}</b>: ${escapeHtml(p.source)}</div>`);
    if (p.category) lines.push(`<div class="popup-line"><b>${t.category}</b>: ${escapeHtml(p.category)}</div>`);
    if (p.cuisine) lines.push(`<div class="popup-line"><b>${t.cuisine}</b>: ${escapeHtml(p.cuisine)}</div>`);
    if (p.address) lines.push(`<div class="popup-line"><b>${t.address}</b>: ${escapeHtml(p.address)}</div>`);

    const actions = [];
    const target = ' target="_blank" rel="noopener" ';

    if (p.kakao_url) {
      actions.push(`<a class="linkbtn" href="${escapeAttr(p.kakao_url)}"${target}>Open in KakaoMap (place)</a>`);
    } else if (lat != null && lon != null) {
      actions.push(`<a class="linkbtn" href="${kakaoSearchWeb(shortKakaoQuery(p), `${lat},${lon}`)}"${target}>Search in KakaoMap</a>`);
      actions.push(`<a class="linkbtn" href="${kakaoLookWeb(lat, lon)}"${target}>Kakao pin</a>`);
    }

    if (lat != null && lon != null) {
      actions.push(`<a class="linkbtn" href="${googleSearch(shortGoogleQuery(p))}"${target}>Search in Google Maps</a>`);
      actions.push(`<a class="linkbtn" href="${googleLook(lat, lon)}"${target}>Google pin</a>`);
    } else {
      actions.push(`<a class="linkbtn" href="${googleSearch(shortGoogleQuery(p))}"${target}>Search in Google Maps</a>`);
    }

    if (userLoc && lat != null && lon != null) {
      actions.push(`<a class="linkbtn" href="${kakaoRouteWeb(userLoc.lat, userLoc.lon, lat, lon, 'foot')}"${target}>Kakao directions (walk)</a>`);
      actions.push(`<a class="linkbtn" href="${kakaoRouteWeb(userLoc.lat, userLoc.lon, lat, lon, 'publictransit')}"${target}>Kakao directions (transit)</a>`);
      actions.push(`<a class="linkbtn" href="${googleDirections(userLoc.lat, userLoc.lon, lat, lon, 'walking')}"${target}>Google directions (walk)</a>`);
      actions.push(`<a class="linkbtn" href="${googleDirections(userLoc.lat, userLoc.lon, lat, lon, 'transit')}"${target}>Google directions (transit)</a>`);
    } else if (lat != null && lon != null) {
      actions.push(`<span class="muted">Tap ‚ÄúUse my location‚Äù to enable directions.</span>`);
    }

    if (p.url) actions.push(`<a class="linkbtn" href="${escapeAttr(p.url)}"${target}>Source page</a>`);

    return title + lines.join("") + `<div class="popup-actions">${actions.join("")}</div>`;
  }

  function michelinRank(cat) {
    cat = (cat || "").toLowerCase();
    if (cat.includes("3") && cat.includes("star")) return 300;
    if (cat.includes("three") && cat.includes("star")) return 300;
    if (cat.includes("2") && cat.includes("star")) return 200;
    if (cat.includes("two") && cat.includes("star")) return 200;
    if (cat.includes("1") && cat.includes("star")) return 100;
    if (cat.includes("one") && cat.includes("star")) return 100;
    if (cat.includes("bib")) return 50;
    if (cat.includes("selected")) return 10;
    return 0;
  }
  function blueRank(cat) {
    cat = (cat || "").toUpperCase();
    if (cat === "RIBBON_THREE") return 30;
    if (cat === "RIBBON_TWO") return 20;
    if (cat === "RIBBON_ONE") return 10;
    return 0;
  }
  function placeRank(p) {
    const src = (p.source || "").toLowerCase();
    if (src.includes("michelin")) return 1000 + michelinRank(p.category);
    if (src.includes("blue")) return 500 + blueRank(p.category);
    return 0;
  }
  function badgeText(p) {
    const src = (p.source || "").toLowerCase();
    const cat = (p.category || "");
    if (src.includes("michelin")) return cat || "Michelin";
    if (src.includes("blue")) {
      if (cat === "RIBBON_THREE") return "Blue 3";
      if (cat === "RIBBON_TWO") return "Blue 2";
      if (cat === "RIBBON_ONE") return "Blue 1";
      return "Blue";
    }
    return "";
  }

  function setUserLocation(lat, lon) {
    userLoc = { lat, lon };
    locStatus.textContent = I18N[LANG].locationSet(lat, lon);
    if (userMarker) userMarker.remove();
    userMarker = L.marker([lat, lon]).addTo(map).bindPopup("You are here");
  }

  locBtn.addEventListener("click", () => {
    if (!navigator.geolocation) { alert("Geolocation not supported."); return; }
    locBtn.disabled = true;
    locStatus.textContent = I18N[LANG].gettingLocation;
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        setUserLocation(pos.coords.latitude, pos.coords.longitude);
        map.setView([pos.coords.latitude, pos.coords.longitude], 14);
        locBtn.disabled = false;
        render();
      },
      (err) => { locStatus.textContent = I18N[LANG].locationFailed(err.message); locBtn.disabled = false; },
      { enableHighAccuracy: true, timeout: 15000, maximumAge: 30000 }
    );
  });

  // Close panel on mobile after changing filters/search (optional but nice)
  function maybeAutoClosePanel() {
    if (isMobile() && panel.classList.contains("open")) {
      // don't auto-close while typing; only on filter changes + fit
      // (kept minimal‚Äîcomment out if you dislike)
    }
  }

  Object.values(filters).forEach(cb => cb.addEventListener("change", () => { render(); maybeAutoClosePanel(); }));
  qEl.addEventListener("input", render);

  fitBtn.addEventListener("click", () => {
    if (!layer) return;
    const bounds = layer.getBounds && layer.getBounds();
    if (bounds && bounds.isValid && bounds.isValid()) map.fitBounds(bounds.pad(0.15));
  });

  let allFeatures = [];
  let layer = null;

  function render() {
    const q = (qEl.value || "").trim();
    const filtered = allFeatures.filter(f => {
      const p = f.properties || {};
      return passesFilters(p) && textMatch(p, q);
    });

    const sorted = filtered.slice().sort((a, b) => {
      const pa = a.properties || {};
      const pb = b.properties || {};
      const ra = placeRank(pa);
      const rb = placeRank(pb);
      if (ra !== rb) return rb - ra;
      return String(pa.name || "").localeCompare(String(pb.name || ""), undefined, { sensitivity: "base" });
    });

    if (layer) { layer.remove(); layer = null; }

    layer = L.geoJSON(sorted, {
      pointToLayer: (feature, latlng) => L.circleMarker(latlng, { radius: 7, weight: 2, fillOpacity: 0.6 }),
      onEachFeature: (feature, l) => {
        const p = feature.properties || {};
        const coords = feature.geometry && feature.geometry.coordinates;
        const lon = coords ? coords[0] : null;
        const lat = coords ? coords[1] : null;
        l.bindPopup(popupHtml(p, lat, lon), { maxWidth: 360 });
      }
    }).addTo(map);

    listEl.innerHTML = "";
    const itemLayers = [];
    layer.eachLayer(l => itemLayers.push(l));

    itemLayers.forEach(l => {
      const f = l.feature || {};
      const p = (f.properties || {});
      const div = document.createElement("div");
      div.className = "list-item";

      const nameEl = document.createElement("div");
      nameEl.textContent = p.name || "(unnamed)";

      const tagEl = document.createElement("div");
      tagEl.className = "tag";
      tagEl.textContent = badgeText(p);

      div.appendChild(nameEl);
      if (tagEl.textContent) div.appendChild(tagEl);

      div.addEventListener("click", () => {
        const latlng = l.getLatLng && l.getLatLng();
        if (latlng) map.setView(latlng, Math.max(map.getZoom(), 15));
        if (l.openPopup) l.openPopup();
      });

      listEl.appendChild(div);
    });

    countEl.textContent = I18N[LANG].placesShown(sorted.length);
  }

  async function boot() {
    const url = "./places.geojson";
    const r = await fetch(url);
    if (!r.ok) throw new Error(`Failed to load ${url}: ${r.status}`);
    const geo = await r.json();
    allFeatures = geo.features || [];

    render();

    // make sure map sizes correctly after fixed header applies on mobile
    setTimeout(() => map.invalidateSize(), 0);
  }

  boot().catch(e => { alert(e.message); console.error(e); });
</script>
</body>
</html>
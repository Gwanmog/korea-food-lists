<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Korea Restaurant Map (Michelin + Blue Ribbon)</title>

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    html, body { height: 100%; margin: 0; }
    #app { display: flex; flex-direction: column; height: 100%; }
    #topbar {<div id="panelBody">
    <div class="row">
  <button id="togglePanel" class="btn">Hide panel</button>
</div>
      padding: 10px; border-bottom: 1px solid #ddd; background: #fff;
      display: grid; gap: 8px;
      </div>
    }
    #topbar.collapsed #panelBody { display: none; }
    const toggleBtn = document.getElementById("togglePanel");
const topbar = document.getElementById("topbar");

toggleBtn.addEventListener("click", () => {
  topbar.classList.toggle("collapsed");
  toggleBtn.textContent = topbar.classList.contains("collapsed") ? "Show panel" : "Hide panel";
});
    #map { flex: 1; }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .pill { padding: 6px 10px; border: 1px solid #ddd; border-radius: 999px; background: #fafafa; }
    .btn { padding: 8px 10px; border: 1px solid #333; border-radius: 10px; background: #111; color: #fff; cursor: pointer; }
    .btn:disabled { opacity: .4; cursor: not-allowed; }
    .muted { color: #666; font-size: 12px; }
    .popup-title { font-weight: 700; margin-bottom: 6px; }
    .popup-line { margin: 2px 0; }
    .popup-actions { margin-top: 8px; display: flex; gap: 8px; flex-wrap: wrap; }
    .linkbtn { display: inline-block; padding: 7px 10px; border: 1px solid #ddd; border-radius: 10px; text-decoration: none; color: #111; background: #fff; }
    .visually-hidden {
    position: absolute;
    left: -10000px;
    width: 1px;
    height: 1px;
    overflow: hidden;
  }
  
    /* --- Sorted list --- */
    #list {
      max-height: 190px;
      overflow: auto;
      border: 1px solid #eee;
      border-radius: 10px;
      padding: 6px;
      background: #fafafa;
    }
    .list-item {
      padding: 6px 8px;
      border-radius: 10px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    .list-item:hover { background: #fff; }
    .tag {
      font-size: 12px;
      color: #333;
      border: 1px solid #ddd;
      border-radius: 999px;
      padding: 2px 8px;
      background: #fff;
      white-space: nowrap;
    }

  </style>
</head>
<body>
<div id="app">
  <div id="topbar">
    <div class="row">
      <button id="locBtn" class="btn">Use my location</button>
      <span id="locStatus" class="muted">Location not set</span>
    </div>

    <div class="row">
      <span class="pill"><label><input type="checkbox" id="f_michelin" checked> Michelin</label></span>
      <span class="pill"><label><input type="checkbox" id="f_blu" checked> Blue Ribbon</label></span>

      <span class="pill"><label><input type="checkbox" id="f_m1" checked> ‚≠ê</label></span>
      <span class="pill"><label><input type="checkbox" id="f_m2" checked> ‚≠ê‚≠ê</label></span>
      <span class="pill"><label><input type="checkbox" id="f_m3" checked> ‚≠ê‚≠ê‚≠ê</label></span>
      <span class="pill"><label><input type="checkbox" id="f_bib" checked> üü¢ Bib</label></span>

      <span class="pill"><label><input type="checkbox" id="f_r1" checked> üîµ</label></span>
      <span class="pill"><label><input type="checkbox" id="f_r2" checked> üîµüîµ</label></span>
      <span class="pill"><label><input type="checkbox" id="f_r3" checked> üîµüîµüîµ</label></span>
    </div>

    <div class="row">
  <label for="q" class="visually-hidden">
    Search restaurants by name, cuisine, or address
  </label>

  <input id="q" type="search"
         placeholder="Search name / cuisine / address‚Ä¶"
         style="flex:1; padding:10px; border-radius:10px; border:1px solid #ddd;">

  <span id="count" class="muted"></span>
</div>
    <div class="muted">
      Tip: Tap a pin ‚Üí ‚ÄúKakao directions‚Äù uses your current location as start (if you tapped ‚ÄúUse my location‚Äù).
    </div>

    <div class="row" style="justify-content: space-between;">
      <span class="muted">Sorted (best first)</span>
      <button id="fitBtn" class="btn" style="background:#fff;color:#111;border-color:#ddd;">Fit to results</button>
    </div>
    <div id="list" aria-label="Sorted restaurant list"></div>
  </div>

  <div id="map"></div>
</div>

<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>

<script>
  // --- Kakao official URL schemes (with mobile web scheme fallbacks) ---
  // From Kakao Maps SDK URL Scheme docs:
  // - search: kakaomap://search?q=...&p=lat,lon
  // - look: kakaomap://look?p=lat,lon
  // - route: kakaomap://route?sp=lat,lon&ep=lat,lon&by=foot|car|publictransit|bicycle
  // Mobile web scheme equivalents: http://m.map.kakao.com/scheme/<action>...
  // (We prefer mobile web scheme in a browser because it‚Äôs safer.)
  // https://apis.map.kakao.com/android_v2/docs/api-guide/urlscheme/

  function enc(s) { return encodeURIComponent(s || ""); }

  function kakaoLookWeb(lat, lon) {
    return `http://m.map.kakao.com/scheme/look?p=${lat},${lon}`;
  }
  function kakaoSearchWeb(query, centerLatLon /* "lat,lon" or null */) {
    if (centerLatLon) return `http://m.map.kakao.com/scheme/search?q=${enc(query)}&p=${centerLatLon}`;
    return `http://m.map.kakao.com/scheme/search?q=${enc(query)}`;
  }
  function kakaoRouteWeb(spLat, spLon, epLat, epLon, by) {
    return `http://m.map.kakao.com/scheme/route?sp=${spLat},${spLon}&ep=${epLat},${epLon}&by=${enc(by || "foot")}`;
  }


  // --- Google Maps URLs ---
  function googleSearch(query) {
    return `https://www.google.com/maps/search/?api=1&query=${enc(query)}`;
  }
  function googleLook(lat, lon) {
    return `https://www.google.com/maps/search/?api=1&query=${lat},${lon}`;
  }
  function googleDirections(spLat, spLon, epLat, epLon, mode) {
    const travelmode = (mode || "walking");
    return `https://www.google.com/maps/dir/?api=1&origin=${spLat},${spLon}&destination=${epLat},${epLon}&travelmode=${enc(travelmode)}`;
  }


  // --- Map ---
  const map = L.map('map', { zoomControl: true }).setView([37.5665, 126.9780], 12); // Seoul default

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  let userLoc = null; // {lat, lon}
  let userMarker = null;

  const locBtn = document.getElementById("locBtn");
  const locStatus = document.getElementById("locStatus");
  const qEl = document.getElementById("q");
  const countEl = document.getElementById("count");
  const listEl = document.getElementById("list");
  const fitBtn = document.getElementById("fitBtn");

  const filters = {
    michelin: document.getElementById("f_michelin"),
    blu: document.getElementById("f_blu"),
    m1: document.getElementById("f_m1"),
    m2: document.getElementById("f_m2"),
    m3: document.getElementById("f_m3"),
    bib: document.getElementById("f_bib"),
    r1: document.getElementById("f_r1"),
    r2: document.getElementById("f_r2"),
    r3: document.getElementById("f_r3"),
  };

  function michelinTierOk(cat) {
  cat = (cat || "").toLowerCase();

  if (cat.includes("three") && cat.includes("star")) return filters.m3.checked;
  if (cat.includes("two") && cat.includes("star")) return filters.m2.checked;
  if (cat.includes("one") && cat.includes("star")) return filters.m1.checked;

  if (cat.includes("3") && cat.includes("star")) return filters.m3.checked;
  if (cat.includes("2") && cat.includes("star")) return filters.m2.checked;
  if (cat.includes("1") && cat.includes("star")) return filters.m1.checked;

  if (cat.includes("bib")) return filters.bib.checked;

  // If user has unchecked all award tiers, hide unknown Michelin too.
const anyTierOn = filters.m1.checked || filters.m2.checked || filters.m3.checked || filters.bib.checked;
if (!anyTierOn) return false;

// Otherwise keep showing Selected/Other when Michelin is enabled
return true;
}

  function ribbonTierOk(cat) {
    cat = (cat || "").toUpperCase();
    if (cat === "RIBBON_THREE") return filters.r3.checked;
    if (cat === "RIBBON_TWO") return filters.r2.checked;
    if (cat === "RIBBON_ONE") return filters.r1.checked;
    return false; // hide non-ribbon categories by default
  }

  function passesFilters(p) {
  const src = (p.source || "").toLowerCase();

  if (src.includes("michelin")) {
    if (!filters.michelin.checked) return false;
    return michelinTierOk(p.category);
  }

  if (src.includes("blue")) { // matches "blueribbon", "blue ribbon", etc.
    if (!filters.blu.checked) return false;
    return ribbonTierOk(p.category);
  }

  return false;
}

  function textMatch(p, q) {
    if (!q) return true;
    q = q.toLowerCase();
    const hay = [
      p.name, p.category, p.cuisine, p.address, p.source
    ].filter(Boolean).join(" ").toLowerCase();
    return hay.includes(q);
  }

  function popupHtml(p, lat, lon) {
    const title = `<div class="popup-title">${escapeHtml(p.name || "")}</div>`;
    const lines = [];
    if (p.source) lines.push(`<div class="popup-line"><b>Source</b>: ${escapeHtml(p.source)}</div>`);
    if (p.category) lines.push(`<div class="popup-line"><b>Category</b>: ${escapeHtml(p.category)}</div>`);
    if (p.cuisine) lines.push(`<div class="popup-line"><b>Cuisine</b>: ${escapeHtml(p.cuisine)}</div>`);
    if (p.address) lines.push(`<div class="popup-line"><b>Address</b>: ${escapeHtml(p.address)}</div>`);

    // Buttons:
    // - If we have coords: look and route
    // - Otherwise: search by name + address
    const q = [p.name, p.address].filter(Boolean).join(" ");
    const center = userLoc ? `${userLoc.lat},${userLoc.lon}` : null;

    const actions = [];
    const target = ' target="_blank" rel="noopener" ';
    // If build step enriched Kakao place_url, prefer direct place page:
    if (p.kakao_url) {actions.push(`<a class="linkbtn" href="${escapeAttr(p.kakao_url)}"${target}>Open in KakaoMap (place)</a>`);
}



    // Prefer search-by-name (closer to "the restaurant") and offer a "pin" look as fallback.
    if (lat != null && lon != null) {
      actions.push(`<a class="linkbtn" href="${kakaoSearchWeb(q, `${lat},${lon}`)}"${target}>Search in KakaoMap</a>`);
      actions.push(`<a class="linkbtn" href="${kakaoLookWeb(lat, lon)}"${target}>Kakao pin</a>`);

      actions.push(`<a class="linkbtn" href="${googleLook(lat, lon)}"${target}>Open in Google Maps</a>`);

      if (userLoc) {
        actions.push(`<a class="linkbtn" href="${kakaoRouteWeb(userLoc.lat, userLoc.lon, lat, lon, 'foot')}"${target}>Kakao directions (walk)</a>`);
        actions.push(`<a class="linkbtn" href="${kakaoRouteWeb(userLoc.lat, userLoc.lon, lat, lon, 'publictransit')}"${target}>Kakao directions (transit)</a>`);
        actions.push(`<a class="linkbtn" href="${googleDirections(userLoc.lat, userLoc.lon, lat, lon, 'walking')}"${target}>Google directions (walk)</a>`);
        actions.push(`<a class="linkbtn" href="${googleDirections(userLoc.lat, userLoc.lon, lat, lon, 'transit')}"${target}>Google directions (transit)</a>`);
      } else {
        actions.push(`<span class="muted">Tap ‚ÄúUse my location‚Äù to enable directions.</span>`);
      }
    } else {
      actions.push(`<a class="linkbtn" href="${kakaoSearchWeb(q, center)}"${target}>Search in KakaoMap</a>`);
      actions.push(`<a class="linkbtn" href="${googleSearch(q)}"${target}>Search in Google Maps</a>`);
    }

    if (p.url) {
      actions.push(`<a class="linkbtn" href="${escapeAttr(p.url)}" target="_blank" rel="noopener">Source page</a>`);
    }

    return title + lines.join("") + `<div class="popup-actions">${actions.join("")}</div>`;
  }

  function escapeHtml(s) {
    return (s || "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }
  function escapeAttr(s) { return escapeHtml(s); }

  let allFeatures = [];
  let layer = null;


  function michelinRank(cat) {
    cat = (cat || "").toLowerCase();
    if (cat.includes("3") && cat.includes("star")) return 300;
    if (cat.includes("three") && cat.includes("star")) return 300;
    if (cat.includes("2") && cat.includes("star")) return 200;
    if (cat.includes("two") && cat.includes("star")) return 200;
    if (cat.includes("1") && cat.includes("star")) return 100;
    if (cat.includes("one") && cat.includes("star")) return 100;
    if (cat.includes("bib")) return 50;
    if (cat.includes("selected")) return 10;
    return 0;
  }

  function blueRank(cat) {
    cat = (cat || "").toUpperCase();
    if (cat === "RIBBON_THREE") return 30;
    if (cat === "RIBBON_TWO") return 20;
    if (cat === "RIBBON_ONE") return 10;
    return 0;
  }

  function placeRank(p) {
    const src = (p.source || "").toLowerCase();
    if (src.includes("michelin")) return 1000 + michelinRank(p.category);
    if (src.includes("blue")) return 500 + blueRank(p.category);
    return 0;
  }

  function badgeText(p) {
    const src = (p.source || "").toLowerCase();
    const cat = (p.category || "");
    if (src.includes("michelin")) return cat || "Michelin";
    if (src.includes("blue")) {
      if (cat === "RIBBON_THREE") return "Blue 3";
      if (cat === "RIBBON_TWO") return "Blue 2";
      if (cat === "RIBBON_ONE") return "Blue 1";
      return "Blue";
    }
    return "";
  }

  function render() {
    const q = (qEl.value || "").trim();
    const filtered = allFeatures.filter(f => {
      const p = f.properties || {};
      return passesFilters(p) && textMatch(p, q);
    });

    // Sort best-first (Michelin stars > Bib > Selected > other; then Blue Ribbon).
    const sorted = filtered.slice().sort((a, b) => {
      const pa = a.properties || {};
      const pb = b.properties || {};
      const ra = placeRank(pa);
      const rb = placeRank(pb);
      if (ra !== rb) return rb - ra;
      return String(pa.name || "").localeCompare(String(pb.name || ""), undefined, { sensitivity: "base" });
    });

if (layer) {
      layer.remove();
      layer = null;
    }

    layer = L.geoJSON(sorted, {
      pointToLayer: (feature, latlng) => L.circleMarker(latlng, { radius: 7, weight: 2, fillOpacity: 0.6 }),
      onEachFeature: (feature, l) => {
        const p = feature.properties || {};
        const coords = feature.geometry && feature.geometry.coordinates;
        const lon = coords ? coords[0] : null;
        const lat = coords ? coords[1] : null;
        l.bindPopup(popupHtml(p, lat, lon), { maxWidth: 360 });
      }
    }).addTo(map);

    // Build clickable sorted list
    listEl.innerHTML = "";
    const itemLayers = [];
    layer.eachLayer(l => itemLayers.push(l));

    itemLayers.forEach(l => {
      const f = l.feature || {};
      const p = (f.properties || {});
      const div = document.createElement("div");
      div.className = "list-item";

      const nameEl = document.createElement("div");
      nameEl.textContent = p.name || "(unnamed)";

      const tagEl = document.createElement("div");
      tagEl.className = "tag";
      tagEl.textContent = badgeText(p);

      div.appendChild(nameEl);
      if (tagEl.textContent) div.appendChild(tagEl);

      div.addEventListener("click", () => {
        const latlng = l.getLatLng && l.getLatLng();
        if (latlng) map.setView(latlng, Math.max(map.getZoom(), 15));
        if (l.openPopup) l.openPopup();
      });

      listEl.appendChild(div);
    });

    countEl.textContent = `${sorted.length} places shown`;
  }

  function setUserLocation(lat, lon) {
    userLoc = { lat, lon };
    locStatus.textContent = `Location set: ${lat.toFixed(5)}, ${lon.toFixed(5)}`;
    if (userMarker) userMarker.remove();
    userMarker = L.marker([lat, lon]).addTo(map).bindPopup("You are here");
  }

  locBtn.addEventListener("click", () => {
    if (!navigator.geolocation) {
      alert("Geolocation not supported on this browser.");
      return;
    }
    locBtn.disabled = true;
    locStatus.textContent = "Getting location‚Ä¶";
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        setUserLocation(lat, lon);
        map.setView([lat, lon], 14);
        locBtn.disabled = false;
        render(); // re-render so Kakao search uses center and directions enable
      },
      (err) => {
        locStatus.textContent = `Location failed: ${err.message}`;
        locBtn.disabled = false;
      },
      { enableHighAccuracy: true, timeout: 15000, maximumAge: 30000 }
    );
  });

  Object.values(filters).forEach(cb => cb.addEventListener("change", render));
  qEl.addEventListener("input", () => render());

  fitBtn.addEventListener("click", () => {
    if (!layer) return;
    const bounds = layer.getBounds && layer.getBounds();
    if (bounds && bounds.isValid && bounds.isValid()) {
      map.fitBounds(bounds.pad(0.15));
    }
  });

  // Load GeoJSON (expects it in ../out/places.geojson or you can copy into site/)
  async function boot() {
    // easiest: copy out/places.geojson into site/places.geojson and use "./places.geojson"
    const url = "./places.geojson";
    const r = await fetch(url);
    if (!r.ok) throw new Error(`Failed to load ${url}: ${r.status}`);
    const geo = await r.json();
    allFeatures = geo.features || [];
    render();
  }

  boot().catch(e => {
    alert(e.message);
    console.error(e);
  });
</script>
</body>
</html>
